let dlList={items:{},postCount:0,fileCount:0,id:"undefined"},limit=0,isIgnoreFree=!1,isEco=!0;export async function main(){if("https://downloads.fanbox.cc"===window.location.origin){document.body.innerHTML="";let t=document.createElement("input");t.type="text";let e=document.createElement("input");return e.type="button",e.value="ok",document.body.appendChild(t),document.body.appendChild(e),void(e.onclick=function(){downloadZip(t.value).then(()=>{})})}if("https://www.fanbox.cc"===window.location.origin){const t=window.location.href.match(/fanbox.cc\/@(.*)/)[1];if(null==t)return void alert("しらないURL");dlList.id=t;const e=window.location.href.match(/fanbox.cc\/@.*\/posts\/(\d*)/);e?addByPostInfo(getPostInfoById(e[1])):await getItemsById(t)}else{if(!window.location.href.match(/^https:\/\/(.*)\.fanbox\.cc\//))return void alert(`ここどこですか(${window.location.href})`);{const t=window.location.href.match(/^https:\/\/(.*)\.fanbox\.cc\//)[1],e=window.location.href.match(/.*\.fanbox\.cc\/posts\/(\d*)/);dlList.id=t,e?addByPostInfo(getPostInfoById(e[1])):await getItemsById(t)}}const t=JSON.stringify(dlList);console.log(t),await navigator.clipboard.writeText(t),alert("jsonをコピーしました。downloads.fanbox.ccで実行して貼り付けてね")}function addByPostListUrl(t,e){const o=JSON.parse(fetchUrl(t)),n=o.body.items;console.log("投稿の数:"+n.length);for(let t=0;t<n.length&&0!==limit;t++)dlList.postCount++,!0===e?(console.log(n[t]),addByPostInfo(n[t])):addByPostInfo(getPostInfoById(n[t].id));return o.body.nextUrl}function fetchUrl(t){const e=new XMLHttpRequest;return e.open("GET",t,!1),e.withCredentials=!0,e.send(null),e.responseText}async function getItemsById(t){dlList.items={},isIgnoreFree=confirm("無料コンテンツを省く？"),limit=prompt("取得制限数を入力 キャンセルで全て取得");let e,o=1;for(e=`https://api.fanbox.cc/post.listCreator?creatorId=${t}&limit=100`;null!=e;o++)console.log(o+"回目"),e=addByPostListUrl(e,isEco),await setTimeout(()=>{},100)}function getPostInfoById(t){return JSON.parse(fetchUrl(`https://api.fanbox.cc/post.info?postId=${t}`)).body}function addByPostInfo(t){const e=t.title,o=t.publishedDatetime;if(!isIgnoreFree||0!==t.feeRequired)if(null!=t.body){if("image"===t.type){const n=t.body.images;for(let t=0;t<n.length;t++)addUrl(e,n[t].originalUrl,`${o} ${e} ${t+1}.${n[t].extension}`)}else if("file"===t.type){const n=t.body.files;for(let t=0;t<n.length;t++)addUrl(e,n[t].url,`${o} ${e} ${n[t].name}.${n[t].extension}`)}else if("article"===t.type){const n=t.body.imageMap,i=Object.keys(n);for(let t=0;t<i.length;t++)addUrl(e,n[i[t]].originalUrl,`${o} ${e} ${t+1}.${n[i[t]].extension}`);const l=t.body.fileMap,s=Object.keys(l);for(let t=0;t<s.length;t++)addUrl(e,l[s[t]].url,`${o} ${e} ${l[s[t]].name}.${l[s[t]].extension}`)}else console.log(`不明なタイプ\n${t.type}@${t.id}`);null!=limit&&limit--}else console.log(`取得できませんでした(支援がたりない？)\nfeeRequired: ${t.feeRequired}@${t.id}`)}function addUrl(t,e,o){const n={url:e,filename:o};dlList.fileCount++,dlList.items[t]||(dlList.items[t]=[]),dlList.items[t].push(n)}async function downloadZip(t){await import("https://cdnjs.cloudflare.com/ajax/libs/jszip/3.6.0/jszip.min.js"),dlList=JSON.parse(t);let e=new JSZip,o=e.folder(dlList.id);for(const[t,e]of Object.entries(dlList.items)){let n=o.folder(t);for(const t of e){console.log(`download ${t.filename}`);const e=await fetch(t.url),o=await e.blob();n.file(t.filename,o),await setTimeout(()=>{},100)}}console.log("ZIPを作成");const n=await e.generateAsync({type:"blob"}),i=URL.createObjectURL(n);let l=document.createElement("a");l.href=i,l.download=`${dlList.id}.zip`,document.body.appendChild(l),l.click(),l.remove(),await setTimeout(()=>window.URL.revokeObjectURL(i),100)}
